const socket = io();

// HTML Elementleri
const loginModal = document.getElementById("loginModal");
const appLayout = document.getElementById("appLayout"); // Blur efekti için
const usernameInput = document.getElementById("usernameInput");
const passwordInput = document.getElementById("passwordInput");
const loginBtn = document.getElementById("loginBtn");

// Genel Sohbet
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const publicMessagesUl = document.getElementById("publicMessages");
const lobbyBtns = document.querySelectorAll(".lobby-btn");

// Özel Mesaj (DM) Elementleri
const privateSidebar = document.getElementById("privateSidebar");
const dmTitle = document.getElementById("dmTitle");
const dmPlaceholder = document.getElementById("dmPlaceholder");
const dmContent = document.getElementById("dmContent");
const privateMessagesUl = document.getElementById("privateMessagesList");
const dmInput = document.getElementById("dmInput");
const dmSendBtn = document.getElementById("dmSendBtn");
const closeDmBtn = document.getElementById("closeDmBtn");

// Ses
const notificationSound = document.getElementById("notificationSound");

let myUsername = "";
let currentRoom = "genel"; 
let currentDmUser = null; // Şu an kiminle özel konuşuyorum?
const userStatusMap = {}; 

/* ---------- 1. GİRİŞ İŞLEMLERİ ---------- */
function doLogin() {
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  
  if (!username || !password) return alert("Kullanıcı adı ve şifre giriniz!");
  
  socket.emit("loginAttempt", { username, password });
}

socket.on("loginSuccess", (approvedUsername) => {
  myUsername = approvedUsername;
  loginModal.classList.add("hidden");
  appLayout.classList.remove("blur"); // Layout'un bluru kalktı
  msgInput.focus();
});

socket.on("loginError", (msg) => { alert(msg); passwordInput.value = ""; });

loginBtn.addEventListener("click", doLogin);
passwordInput.addEventListener("keypress", (e) => { if(e.key === "Enter") doLogin(); });

/* ---------- 2. GENEL ODA DEĞİŞTİRME ---------- */
lobbyBtns.forEach((btn) => {
  btn.addEventListener("click", () => {
    const roomName = btn.dataset.room;
    if (roomName === currentRoom) return;
    
    document.querySelector(".lobby-btn.active").classList.remove("active");
    btn.classList.add("active");
    publicMessagesUl.innerHTML = "";
    
    currentRoom = roomName;
    socket.emit("joinRoom", currentRoom);
  });
});

/* ---------- 3. GENEL MESAJ GÖNDERME ---------- */
function sendPublicMessage() {
  const text = msgInput.value.trim();
  if (!text || !myUsername) return;

  const time = getNow();
  socket.emit("sendMessage", { text, time });
  msgInput.value = "";
  msgInput.focus();
}

sendBtn.addEventListener("click", sendPublicMessage);
msgInput.addEventListener("keypress", (e) => { if(e.key === "Enter") sendPublicMessage(); });

/* ---------- 4. ÖZEL MESAJ (DM) SİSTEMİ ---------- */

// A) Bir isme tıklandığında DM penceresini hazırla
function openPrivateChat(targetUser) {
  if (targetUser === myUsername) return; // Kendine mesaj atama

  currentDmUser = targetUser;
  dmTitle.innerText = `DM: ${targetUser}`;
  
  // Arayüzü aç
  dmPlaceholder.classList.add("hidden");
  dmContent.classList.remove("hidden");
  
  // Önceki mesajları temizle ve geçmişi iste
  privateMessagesUl.innerHTML = "";
  socket.emit("getPrivateHistory", targetUser);
  
  dmInput.focus();
}

// B) DM Gönderme
function sendPrivateMessage() {
  const text = dmInput.value.trim();
  if (!text || !currentDmUser) return;
  
  const time = getNow();
  
  // Sunucuya gönder
  socket.emit("privateMessage", {
    to: currentDmUser,
    text: text,
    time: time
  });
  
  // Hemen kendi ekranıma ekle
  addMessage(myUsername, text, time, privateMessagesUl, true);
  dmInput.value = "";
  dmInput.focus();
}

dmSendBtn.addEventListener("click", sendPrivateMessage);
dmInput.addEventListener("keypress", (e) => { if(e.key === "Enter") sendPrivateMessage(); });

closeDmBtn.addEventListener("click", () => {
  currentDmUser = null;
  dmTitle.innerText = "Özel Mesaj";
  dmPlaceholder.classList.remove("hidden");
  dmContent.classList.add("hidden");
});

/* ---------- 5. SUNUCUDAN GELENLER ---------- */

// Genel Mesaj
socket.on("newMessage", (msg) => {
  addMessage(msg.username, msg.text, msg.time, publicMessagesUl, false);
  if (msg.username !== myUsername) playSound();
});

// Genel Geçmiş
socket.on("loadHistory", (messages) => {
  publicMessagesUl.innerHTML = "";
  messages.forEach((msg) => addMessage(msg.username, msg.text, msg.time, publicMessagesUl, false));
});

// DM Geldiğinde
socket.on("receivePrivateMessage", (msg) => {
  // Eğer şu an o kişiyle konuşuyorsam ekrana bas
  if (currentDmUser === msg.from) {
    addMessage(msg.from, msg.text, msg.time, privateMessagesUl, true);
  } else {
    // Başkasıyla konuşuyorsam veya panel kapalıysa bildirim ver (İleride buraya kırmızı nokta eklenebilir)
    alert(`${msg.from} sana özel mesaj attı!`);
  }
  playSound();
});

// DM Geçmişi Yüklendiğinde
socket.on("loadPrivateHistory", (messages) => {
  privateMessagesUl.innerHTML = "";
  messages.forEach((msg) => {
    // Kimin gönderdiğini kontrol et
    addMessage(msg.sender, msg.text, msg.time, privateMessagesUl, true);
  });
});

socket.on("userStatus", ({ username, online }) => {
  userStatusMap[username] = online ? "online" : "offline";
  // (Burada tüm listeyi güncelleme fonksiyonu çağrılabilir)
});

/* ---------- YARDIMCI FONKSİYONLAR ---------- */

function getNow() {
  return new Date().toLocaleTimeString("tr-TR", { hour: "2-digit", minute: "2-digit", hour12: false });
}

function playSound() {
  notificationSound.play().catch(e => console.log(e));
}

// Mesajı Ekrana Basan Fonksiyon
// targetUl: Hangi listeye eklenecek? (Genel mi Özel mi?)
// isPrivate: Özel mesaj mı? (İsim tıklanabilirliği için önemli)
function addMessage(username, text, time, targetUl, isPrivate) {
  const li = document.createElement("li");
  li.classList.add("message");
  
  if (username === myUsername) li.classList.add("mine");
  
  const header = document.createElement("div");
  header.classList.add("message-header");

  const senderSpan = document.createElement("span");
  senderSpan.classList.add("sender");
  senderSpan.textContent = username;
  
  // Sadece GENEL SOHBETTE ve BAŞKASININ ismine tıklayınca DM aç
  if (!isPrivate && username !== myUsername) {
    senderSpan.onclick = () => openPrivateChat(username);
    senderSpan.title = "Özel mesaj at";
  }

  const dateSpan = document.createElement("span");
  dateSpan.classList.add("date");
  dateSpan.textContent = time;

  header.appendChild(senderSpan);
  header.appendChild(dateSpan);

  const p = document.createElement("p");
  p.textContent = text;

  li.appendChild(header);
  li.appendChild(p);
  
  targetUl.appendChild(li);
  targetUl.scrollTop = targetUl.scrollHeight;
}
